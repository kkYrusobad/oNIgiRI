#!/bin/bash

# niri-menu: Omarchy-style system menu for Niri
# Uses fuzzel with refined aesthetics and JetBrainsMono Nerd Font

export PATH="$HOME/garbage/editniri/niri-omarchy-port/bin:$PATH"

BACK_TO_EXIT=false

# ─────────────────────────────────────────────────────────────────────────────
# Fuzzel options - Noctalia shell color scheme
# ─────────────────────────────────────────────────────────────────────────────
FUZZEL_OPTS=(
    "--font=JetBrainsMono Nerd Font:size=12"
    "--background=282828e6"           # mSurface with ~90% opacity
    "--text-color=fbf1c7ff"           # mOnSurface
    "--selection-color=3c3836e6"      # mSurfaceVariant
    "--selection-text-color=b8bb26ff" # mPrimary (green)
    "--border-color=57514eff"         # mOutline
    "--match-color=fabd2fff"          # mSecondary (yellow)
    "--horizontal-pad=16"
    "--vertical-pad=12"
    "--inner-pad=8"
)

# ─────────────────────────────────────────────────────────────────────────────
# Helper Functions
# ─────────────────────────────────────────────────────────────────────────────

back_to() {
    local parent_menu="$1"
    if [[ "$BACK_TO_EXIT" == "true" ]]; then
        exit 0
    elif [[ -n "$parent_menu" ]]; then
        "$parent_menu"
    else
        show_main_menu
    fi
}

menu() {
    local prompt="$1"
    local options="$2"
    
    echo -e "$options" | fuzzel --dmenu \
        --width 40 \
        --lines 10 \
        --prompt " $prompt  " \
        "${FUZZEL_OPTS[@]}" \
        2>/dev/null
}

terminal() {
    alacritty "$@"
}

present_terminal() {
    niri-launch-or-focus-tui --floating --center --name presentation "bash -c '$1'"
}

open_in_editor() {
    notify-send "󰏫  Editing" "$1"
    "${EDITOR:-nvim}" "$1"
}

# ─────────────────────────────────────────────────────────────────────────────
# Learn Menu
# ─────────────────────────────────────────────────────────────────────────────

show_learn_menu() {
    case $(menu "Learn" "󰌌  Keybindings\n󰨡  Niri Wiki\n󰣇  Arch Wiki\n  Neovim Docs\n  Bash Reference") in
    *Keybindings*) niri-menu-keybindings ;;
    *Niri*) xdg-open "https://github.com/YaLTeR/niri/wiki" ;;
    *Arch*) xdg-open "https://wiki.archlinux.org/title/Main_page" ;;
    *Neovim*) xdg-open "https://www.lazyvim.org/keymaps" ;;
    *Bash*) xdg-open "https://devhints.io/bash" ;;
    *) show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Trigger Menu
# ─────────────────────────────────────────────────────────────────────────────

show_trigger_menu() {
    case $(menu "Trigger" "󰹑  Screenshot\n󰔎  Toggle\n󰕧  Screenrecord\n󰏘  Color Picker") in
    *Screenshot*) show_screenshot_menu ;;
    *Toggle*) show_toggle_menu ;;
    *Screenrecord*) notify-send "󰕧  Screenrecord" "Coming soon..." ;;
    *Color*) notify-send "󰏘  Color" "Coming soon..." ;;
    *) show_main_menu ;;
    esac
}

show_toggle_menu() {
    case $(menu "Toggle" "󱄅  Screensaver\n󰔎  Nightlight") in
    *Screensaver*) niri-toggle-screensaver ;;
    *Nightlight*) niri-toggle-nightlight ;;
    *) back_to show_trigger_menu ;;
    esac
}

show_screenshot_menu() {
    case $(menu "Screenshot" "󰹑  Select Region\n󰍹  Full Screen\n󰆏  To Clipboard Only") in
    *Region*) niri-cmd-screenshot region ;;
    *Full*) niri-cmd-screenshot fullscreen ;;
    *Clipboard*) niri-cmd-screenshot clipboard ;;
    *) back_to show_trigger_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Style Menu
# ─────────────────────────────────────────────────────────────────────────────

show_style_menu() {
    case $(menu "Style" "󰏘  Theme\n󰒓  Niri Config\n󱄅  Screensaver\n󰋽  About Text") in
    *Theme*) show_theme_menu ;;
    *Niri*) open_in_editor ~/.config/niri/config.kdl ;;
    *Screensaver*) open_in_editor /home/kky/garbage/editniri/niri-omarchy-port/branding/screensaver.txt ;;
    *About*) open_in_editor /home/kky/garbage/editniri/niri-omarchy-port/branding/about.txt ;;
    *) show_main_menu ;;
    esac
}

show_theme_menu() {
    notify-send "󰏘  Theme" "Theme selection coming soon..."
    back_to show_style_menu
}

# ─────────────────────────────────────────────────────────────────────────────
# System Menu
# ─────────────────────────────────────────────────────────────────────────────

show_system_menu() {
    case $(menu "System" "󰌾  Lock Screen\n󱄅  Screensaver\n󰒲  Suspend\n󰜉  Restart\n󰐥  Shutdown") in
    *Lock*) 
        if command -v qs &>/dev/null; then
            qs -c noctalia-shell ipc call lockScreen lock
        else
            swaylock
        fi
        ;;
    *Screensaver*) niri-launch-screensaver force ;;
    *Suspend*) systemctl suspend ;;
    *Restart*) niri-launch-or-focus-tui --floating --center --name Confirm niri-cmd-reboot ;;
    *Shutdown*) niri-launch-or-focus-tui --floating --center --name Confirm niri-cmd-shutdown ;;
    *) back_to show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Setup Menu - Uses Noctalia IPC where available
# ─────────────────────────────────────────────────────────────────────────────

show_setup_menu() {
    case $(menu "Setup" "󰕾  Audio\n󰖩  WiFi\n󰂯  Bluetooth\n󱐋  Power Profile\n󰒓  Settings\n󰔎  Dark Mode") in
    *Audio*) qs -c noctalia-shell ipc call controlCenter toggle ;;
    *WiFi*) rfkill unblock wifi; niri-launch-or-focus-tui --floating --center --name WiFi impala ;;
    *Bluetooth*) rfkill unblock bluetooth; niri-launch-or-focus-tui --floating --center --name Bluetooth bluetui ;;
    *Power*) show_power_profile_menu ;;
    *Settings*) qs -c noctalia-shell ipc call settings toggle ;;
    *Dark*) qs -c noctalia-shell ipc call darkMode toggle ;;
    *) show_main_menu ;;
    esac
}

show_power_profile_menu() {
    case $(menu "Power" "󱐋  Performance\n󰾅  Balanced\n󰾆  Power Saver\n󰑐  Cycle") in
    *Performance*) qs -c noctalia-shell ipc call powerProfile set performance ;;
    *Balanced*) qs -c noctalia-shell ipc call powerProfile set balanced ;;
    *Saver*) qs -c noctalia-shell ipc call powerProfile set powersaver ;;
    *Cycle*) qs -c noctalia-shell ipc call powerProfile cycle ;;
    *) back_to show_setup_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Install Menu
# ─────────────────────────────────────────────────────────────────────────────

show_install_menu() {
    case $(menu "Install" "󰏗  Package\n󰣇  AUR Package\n󰖟  Web App\n󰆍  TUI App") in
    *Web*) niri-launch-or-focus-tui --floating --center --name WebAppInstall niri-webapp-install ;;
    *TUI*App*) niri-launch-or-focus-tui --floating --center --name TUIInstall niri-tui-install ;;
    *Package*) niri-launch-or-focus-tui --floating --center --name PkgInstall niri-pkg-install ;;
    *AUR*) niri-launch-or-focus-tui --floating --center --name AURInstall niri-pkg-aur-install ;;
    *) show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Remove Menu
# ─────────────────────────────────────────────────────────────────────────────

show_remove_menu() {
    case $(menu "Remove" "󱧖  Package\n󱍕  My App") in
    *My*App*) niri-launch-or-focus-tui --floating --center --name AppRemove niri-custom-apps-remove ;;
    *Package*) niri-launch-or-focus-tui --floating --center --name PkgRemove niri-pkg-remove ;;
    *) show_main_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Main Menu
# ─────────────────────────────────────────────────────────────────────────────

show_main_menu() {
    #go_to_menu "$(menu "Menu" "󰀻  Apps\n󱍕  My Apps\n󰠮  Learn\n󰹑  Trigger\n󰃣  Style\n󰒓  Setup\n󰉉  Install\n󰋽  About\n  System")"
    go_to_menu "$(menu "󰻀" "󱍕  My Apps\n󰠮  Learn\n󰹑  Trigger\n󰃣  Style\n󰒓  Setup\n󰏔  Install\n󱧖  Remove\n󰋽  About\n󱩊  System")"
}

go_to_menu() {
    case "${1,,}" in
    *my*apps*) niri-custom-apps-menu ;;
    #*apps*) niri-apps-menu ;;
    *learn*) show_learn_menu ;;
    *trigger*) show_trigger_menu ;;
    *style*) show_style_menu ;;
    *setup*) show_setup_menu ;;
    *install*) show_install_menu ;;
    *remove*) show_remove_menu ;;
    *about*) niri-launch-about ;;
    *system*) show_system_menu ;;
    esac
}

# ─────────────────────────────────────────────────────────────────────────────
# Entry Point
# ─────────────────────────────────────────────────────────────────────────────

if [[ -n "$1" ]]; then
    BACK_TO_EXIT=true
    go_to_menu "$1"
else
    show_main_menu
fi
