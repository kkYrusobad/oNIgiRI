#!/bin/bash

screensaver_in_focus() {
  # Check if the active window is the screensaver
  niri msg -j windows | jq -e '.[] | select(.is_focused == true) | select(.app_id == "org.niri.screensaver")' >/dev/null 2>&1
}

exit_screensaver() {
  # Note: Niri doesn't have cursor:invisible option like Hyprland
  # The cursor will remain visible during screensaver
  pkill -x tte 2>/dev/null
  pkill -f org.niri.screensaver 2>/dev/null
  exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

printf '\033]11;rgb:00/00/00\007'  # Set background color to black

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
SCREENSAVER_TEXT="$PROJECT_DIR/branding/screensaver.txt"

# Check if screensaver text file exists
if [[ ! -f "$SCREENSAVER_TEXT" ]]; then
  echo "Error: Screensaver text file not found at $SCREENSAVER_TEXT"
  exit 1
fi

while true; do
  tte -i "$SCREENSAVER_TEXT" \
    --frame-rate 120 --canvas-width 0 --canvas-height 0 --reuse-canvas --anchor-canvas c --anchor-text c \
    --random-effect --exclude-effects dev_worm \
    --no-eol --no-restore-cursor &

  while pgrep -x tte >/dev/null; do
    if read -n 1 -t 1 || ! screensaver_in_focus; then
      exit_screensaver
    fi
  done
done
